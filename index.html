<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CoinScan</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    select, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #results {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    #chart {
      max-width: 800px;
      margin-top: 20px;
    }
    #loading {
      display: none;
      font-weight: bold;
      color: #333;
    }
    #debug {
      display: none;
      margin-top: 20px;
      background-color: #fff;
      padding: 10px;
      border: 1px solid #ddd;
    }
    #debug-toggle {
      cursor: pointer;
      color: #007BFF;
    }
  </style>
</head>
<body>
  <div>
    <label for="category">Category:</label>
    <select id="category">
      <option value="crypto">Crypto</option>
      <option value="forex">Forex</option>
      <option value="commodities">Commodities</option>
      <option value="stocks">Stocks</option>
    </select>
  </div>

  <div>
    <label for="asset">Asset:</label>
    <select id="asset">
      <!-- Populated dynamically -->
    </select>
  </div>

  <div>
    <label for="timeframe">Timeframe:</label>
    <select id="timeframe">
      <option value="1">1 Day</option>
      <option value="7">7 Days</option>
      <option value="30">30 Days</option>
      <option value="90">90 Days</option>
    </select>
  </div>

  <button id="analyzeBtn">Analyze</button>
  <div id="loading">Loading...</div>

  <div id="results">
    <canvas id="chart"></canvas>
    <table id="results-table">
      <thead>
        <tr>
          <th>Strategy</th>
          <th>Signal</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody id="results-body"></tbody>
    </table>
  </div>

  <div id="debug-toggle">üêû Show/Hide Debug</div>
  <pre id="debug"></pre>

  <script type="module">
    import { strategies } from './strategies.js';

    const apiKey = 'L3TSRCE68L4L2KKJ';
    const categorySelect = document.getElementById('category');
    const assetSelect = document.getElementById('asset');
    const timeframeSelect = document.getElementById('timeframe');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loadingDiv = document.getElementById('loading');
    const resultsBody = document.getElementById('results-body');
    const debugDiv = document.getElementById('debug');
    const debugToggle = document.getElementById('debug-toggle');
    let chart;

    // Asset lists
    const assets = {
      crypto: [
        { label: 'Bitcoin (BTC/USD)', symbol: 'BTC', market: 'USD' },
        { label: 'Ethereum (ETH/USD)', symbol: 'ETH', market: 'USD' },
        { label: 'Litecoin (LTC/USD)', symbol: 'LTC', market: 'USD' },
        { label: 'Ripple (XRP/USD)', symbol: 'XRP', market: 'USD' },
        { label: 'Solana (SOL/USD)', symbol: 'SOL', market: 'USD' },
        { label: 'Cardano (ADA/USD)', symbol: 'ADA', market: 'USD' },
        { label: 'Dogecoin (DOGE/USD)', symbol: 'DOGE', market: 'USD' },
        { label: 'Polkadot (DOT/USD)', symbol: 'DOT', market: 'USD' },
        { label: 'Binance Coin (BNB/USD)', symbol: 'BNB', market: 'USD' },
        { label: 'Avalanche (AVAX/USD)', symbol: 'AVAX', market: 'USD' }
      ],
      forex: [
        { label: 'EUR/USD', from: 'EUR', to: 'USD' },
        { label: 'GBP/USD', from: 'GBP', to: 'USD' },
        { label: 'USD/JPY', from: 'USD', to: 'JPY' },
        { label: 'AUD/USD', from: 'AUD', to: 'USD' },
        { label: 'USD/CAD', from: 'USD', to: 'CAD' },
        { label: 'EUR/JPY', from: 'EUR', to: 'JPY' },
        { label: 'GBP/JPY', from: 'GBP', to: 'JPY' }
      ],
      commodities: [
        { label: 'Gold (XAU/USD)', from: 'XAU', to: 'USD' },
        { label: 'Silver (XAG/USD)', from: 'XAG', to: 'USD' },
        { label: 'Crude Oil (WTI/USD)', from: 'WTI', to: 'USD' }
      ],
      stocks: [
        { label: 'Apple (AAPL)', symbol: 'AAPL' },
        { label: 'Tesla (TSLA)', symbol: 'TSLA' },
        { label: 'Google (GOOG)', symbol: 'GOOG' },
        { label: 'Amazon (AMZN)', symbol: 'AMZN' },
        { label: 'Microsoft (MSFT)', symbol: 'MSFT' },
        { label: 'NVIDIA (NVDA)', symbol: 'NVDA' },
        { label: 'Meta (META)', symbol: 'META' }
      ]
    };

    // Populate asset dropdown
    function populateAssets(category) {
      assetSelect.innerHTML = '';
      assets[category].forEach(asset => {
        const option = document.createElement('option');
        option.value = asset.symbol || `${asset.from}/${asset.to}`;
        option.textContent = asset.label;
        assetSelect.appendChild(option);
      });
    }

    // Initial population
    populateAssets(categorySelect.value);

    // Update assets on category change
    categorySelect.addEventListener('change', (e) => {
      populateAssets(e.target.value);
    });

    // Debug toggle
    debugToggle.addEventListener('click', () => {
      debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
    });

    // Analyze button handler
    analyzeBtn.addEventListener('click', async () => {
      const category = categorySelect.value;
      const assetValue = assetSelect.value;
      const timeframeDays = parseInt(timeframeSelect.value);
      let endpoint, params;

      // Set API endpoint and parameters
      if (category === 'crypto') {
        endpoint = 'DIGITAL_CURRENCY_DAILY';
        params = { symbol: assetValue.split('/')[0], market: 'USD' };
      } else if (category === 'forex' || category === 'commodities') {
        endpoint = 'FX_DAILY';
        const [from, to] = assetValue.split('/');
        params = { from_symbol: from, to_symbol: to };
      } else if (category === 'stocks') {
        endpoint = 'TIME_SERIES_DAILY';
        params = { symbol: assetValue };
      }

      loadingDiv.style.display = 'block';
      resultsBody.innerHTML = '';
      if (chart) chart.destroy();

      try {
        const response = await fetch(`https://www.alphavantage.co/query?function=${endpoint}&${new URLSearchParams(params)}&outputsize=full&apikey=${apiKey}`);
        const json = await response.json();

        // Handle API errors
        if (json['Error Message'] || json['Information']) {
          throw new Error(json['Error Message'] || json['Information'] || 'API error occurred');
        }

        const timeSeries = json['Time Series (Daily)'] || json['Time Series FX (Daily)'] || json['Time Series Crypto (Daily)'];
        if (!timeSeries) throw new Error('No data returned from API');

        // Get and sort dates (most recent first)
        const dates = Object.keys(timeSeries).sort((a, b) => new Date(b) - new Date(a));
        const recentDates = dates.slice(0, timeframeDays);
        const data = recentDates.map(date => ({
          price: parseFloat(timeSeries[date]['4. close'] || timeSeries[date]['close'] || 0),
          high: parseFloat(timeSeries[date]['2. high'] || timeSeries[date]['high'] || 0),
          low: parseFloat(timeSeries[date]['3. low'] || timeSeries[date]['low'] || 0),
          open: parseFloat(timeSeries[date]['1. open'] || timeSeries[date]['open'] || 0),
          volume: parseFloat(timeSeries[date]['5. volume'] || timeSeries[date]['volume'] || 0),
          timestamp: date
        }));

        // Debug data
        debugDiv.textContent = JSON.stringify({ dataLength: data.length, sample: data.slice(0, 5) }, null, 2);

        // Run strategies
        const results = strategies.map(strategy => strategy.evaluate(data));

        // Display chart
        const chartCtx = document.getElementById('chart').getContext('2d');
        chart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels: recentDates.reverse(), // Oldest to newest for chart
            datasets: [{
              label: `${assetValue} Close Price`,
              data: data.map(d => d.price).reverse(),
              borderColor: '#4CAF50',
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: 'Date' } },
              y: { title: { display: true, text: 'Price (USD)' } }
            }
          }
        });

        // Display results table
        results.forEach(result => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${result.description}</td>
            <td>${result.signal}</td>
            <td>${result.description}</td>
          `;
          resultsBody.appendChild(row);
        });
      } catch (error) {
        console.error('API Error:', error);
        resultsBody.innerHTML = `<tr><td colspan="3">Error: ${error.message}. Try again or check API key (free tier limits: 25 calls/day).</td></tr>`;
      } finally {
        loadingDiv.style.display = 'none';
      }
    });
  </script>
</body>
</html>
