<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinScan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/dist/chartjs-chart-financial.js"></script>
</head>
<body>
    <div>
        <label for="coin">Coin:</label>
        <select id="coin">
            <option>Avalanche</option>
            <option>Binance Coin</option>
            <option>Bitcoin</option>
            <option>Cardano</option>
            <option>Dogecoin</option>
            <option>Ethereum</option>
            <option>Litecoin</option>
            <option>Polkadot</option>
            <option>Ripple</option>
            <option>Solana</option>
        </select>
    </div>

    <div>
        <label for="timeframe">Timeframe:</label>
        <select id="timeframe">
            <option>1 Day</option>
            <option>7 Days</option>
            <option>30 Days</option>
            <option>90 Days</option>
        </select>
    </div>

    <button onclick="runAnalysis()">Analyze</button>

    <div id="chartContainer">
        <canvas id="cryptoChart"></canvas>
    </div>

    <div id="results"></div>

    <div>
        üêû <button onclick="toggleDebug()">Show/Hide Debug</button>
        <div id="debug" style="display: none;"></div>
    </div>

    <script>
        // Coin ID mapping for CoinGecko API
        const coinIds = {
            'Avalanche': 'avalanche',
            'Binance Coin': 'binancecoin',
            'Bitcoin': 'bitcoin',
            'Cardano': 'cardano',
            'Dogecoin': 'dogecoin',
            'Ethereum': 'ethereum',
            'Litecoin': 'litecoin',
            'Polkadot': 'polkadot',
            'Ripple': 'xrp',
            'Solana': 'solana'
        };

        // Fetch OHLCV data from CoinGecko
        async function fetchCryptoData(coin, timeframe) {
            try {
                const id = coinIds[coin];
                if (!id) throw new Error('Invalid coin selected');

                const daysMap = {
                    '1 Day': 1,
                    '7 Days': 7,
                    '30 Days': 30,
                    '90 Days': 90
                };
                const days = daysMap[timeframe];
                if (!days) throw new Error('Invalid timeframe selected');

                const ohlcUrl = `https://api.coingecko.com/api/v3/coins/${id}/ohlc?vs_currency=usd&days=${days}`;
                const marketUrl = `https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=${days}`;

                const [ohlcRes, marketRes] = await Promise.all([
                    fetch(ohlcUrl),
                    fetch(marketUrl)
                ]);

                if (!ohlcRes.ok || !marketRes.ok) {
                    throw new Error('Failed to fetch data from CoinGecko API');
                }

                const ohlcData = await ohlcRes.json();
                const marketData = await marketRes.json();

                // Create a map of timestamps to volumes
                const volumeMap = new Map(marketData.total_volumes.map(([t, v]) => [t, v]));

                // Integrate OHLC with volume data
                const mergedData = ohlcData.map(([timestamp, o, h, l, c]) => ({
                    timestamp,
                    o,
                    h,
                    l,
                    c,
                    v: volumeMap.get(timestamp) || 0
                }));

                return mergedData;
            } catch (error) {
                console.error('Error fetching crypto data:', error);
                document.getElementById('debug').innerText = `Error: ${error.message}`;
                return [];
            }
        }

        // Run analysis and render candlestick chart
        async function runAnalysis() {
            const coin = document.getElementById('coin').value;
            const timeframe = document.getElementById('timeframe').value;

            const data = await fetchCryptoData(coin, timeframe);

            if (data.length === 0) {
                alert('No data available for the selected coin and timeframe.');
                return;
            }

            const ctx = document.getElementById('cryptoChart').getContext('2d');

            // Destroy existing chart if any
            if (window.myChart) {
                window.myChart.destroy();
            }

            // Create candlestick chart
            window.myChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: `${coin} Price`,
                        data: data.map(d => ({
                            x: d.timestamp,
                            o: d.o,
                            h: d.h,
                            l: d.l,
                            c: d.c
                        })),
                        color: {
                            up: 'rgba(0, 255, 0, 0.7)', // Green for bullish
                            down: 'rgba(255, 0, 0, 0.7)', // Red for bearish
                            unchanged: 'rgba(128, 128, 128, 0.7)' // Gray for neutral
                        },
                        borderColor: {
                            up: 'green',
                            down: 'red',
                            unchanged: 'gray'
                        }
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                parser: 'timestamp',
                                tooltipFormat: 'll HH:mm'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            }
                        }
                    }
                }
            });

            // Placeholder for strategy evaluation (assumes strategies.js is included)
            // Example: const results = strategies.map(s => s.evaluate(data)).filter(r => r.match);
            // document.getElementById('results').innerHTML = results.map(r => `<p>${r.description}: ${r.signal}</p>`).join('');
        }

        // Toggle debug section visibility
        function toggleDebug() {
            const debug = document.getElementById('debug');
            debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        }

        // Note: Ensure <script src="strategies.js"></script> is included if strategies are in a separate file
    </script>
</body>
</html>
