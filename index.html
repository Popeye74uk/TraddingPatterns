<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CoinScan</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    /* Add your original styles if any */
  </style>
</head>
<body>
  <div>
    <label for="category">Category:</label>
    <select id="category">
      <option value="crypto">Crypto</option>
      <option value="forex">Forex</option>
      <option value="commodities">Commodities</option>
      <option value="stocks">Stocks</option>
    </select>
  </div>

  <div>
    <label for="asset">Asset:</label>
    <select id="asset">
      <!-- Populated dynamically -->
    </select>
  </div>

  <div>
    <label for="timeframe">Timeframe:</label>
    <select id="timeframe">
      <option value="1">1 Day</option>
      <option value="7">7 Days</option>
      <option value="30">30 Days</option>
      <option value="90">90 Days</option>
    </select>
  </div>

  <button id="analyzeBtn">Analyze</button>

  <div id="results">Loading Data...</div>

  <canvas id="chart"></canvas>

  <div id="debug-toggle">üêû Show/Hide Debug</div>
  <pre id="debug"></pre>

  <script type="module">
    import { strategies } from './strategies.js';

    const apiKey = 'L3TSRCE68L4L2KKJ'; // Alpha Vantage key

    const categorySelect = document.getElementById('category');
    const assetSelect = document.getElementById('asset');
    const timeframeSelect = document.getElementById('timeframe');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultsDiv = document.getElementById('results');
    const debugDiv = document.getElementById('debug');
    const debugToggle = document.getElementById('debug-toggle');
    let chart;

    // Asset lists for each category
    const assets = {
      crypto: [
        { label: 'Avalanche', symbol: 'AVAXUSDT' },
        { label: 'Binance Coin', symbol: 'BNBUSDT' },
        { label: 'Bitcoin', symbol: 'BTCUSDT' },
        { label: 'Cardano', symbol: 'ADAUSDT' },
        { label: 'Dogecoin', symbol: 'DOGEUSDT' },
        { label: 'Ethereum', symbol: 'ETHUSDT' },
        { label: 'Litecoin', symbol: 'LTCUSDT' },
        { label: 'Polkadot', symbol: 'DOTUSDT' },
        { label: 'Ripple', symbol: 'XRPUSDT' },
        { label: 'Solana', symbol: 'SOLUSDT' }
      ],
      forex: [
        { label: 'EUR/USD', symbol: 'EURUSDT' },
        { label: 'GBP/USD', symbol: 'GBPUSDT' },
        { label: 'USD/JPY', symbol: 'USDJPY' }, // Note: Binance has JPYUSDT or similar; adjust if needed
        { label: 'AUD/USD', symbol: 'AUDUSDT' },
        { label: 'USD/CAD', symbol: 'USDCAD' } // Adjust for Binance symbols
      ],
      commodities: [
        { label: 'Gold', symbol: 'XAUUSDT' },
        { label: 'Silver', symbol: 'XAGUSDT' },
        { label: 'Oil', symbol: 'OILUSDT' } // Adjust if Binance symbol is different
      ],
      stocks: [
        { label: 'Apple', symbol: 'AAPL' },
        { label: 'Binance Coin', symbol: 'BNB' }, // Binance is crypto; for stocks, use Alpha Vantage symbols
        { label: 'Bitcoin', symbol: 'BTC' }, // Crypto; adjust list for pure stocks
        { label: 'Cardano', symbol: 'ADA' }, // Crypto
        { label: 'Dogecoin', symbol: 'DOGE' }, // Crypto
        { label: 'Ethereum', symbol: 'ETH' }, // Crypto
        { label: 'Litecoin', symbol: 'LTC' }, // Crypto
        { label: 'Polkadot', symbol: 'DOT' }, // Crypto
        { label: 'Ripple', symbol: 'XRP' }, // Crypto
        { label: 'Solana', symbol: 'SOL' } // Crypto
      ]
    };

    // Populate asset dropdown based on category
    function populateAssets(category) {
      assetSelect.innerHTML = '';
      assets[category].forEach(asset => {
        const option = document.createElement('option');
        option.value = asset.symbol;
        option.textContent = asset.label;
        assetSelect.appendChild(option);
      });
    }

    // Initial population
    populateAssets(categorySelect.value);

    // Update assets on category change
    categorySelect.addEventListener('change', (e) => {
      populateAssets(e.target.value);
    });

    // Debug toggle
    debugToggle.addEventListener('click', () => {
      debugDiv.style.display = debugDiv.style.display === 'block' ? 'none' : 'block';
    });

    // Analyze button handler
    analyzeBtn.addEventListener('click', async () => {
      resultsDiv.innerHTML = 'Loading Data...';
      const category = categorySelect.value;
      const assetValue = assetSelect.value;
      const timeframeDays = parseInt(timeframeSelect.value);
      let data = [];

      try {
        if (category === 'stocks') {
          // Use Alpha Vantage for stocks
          const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${assetValue}&outputsize=compact&apikey=${apiKey}`);
          const json = await response.json();
          const timeSeries = json['Time Series (Daily)'];
          if (!timeSeries) throw new Error('No data returned');
          const dates = Object.keys(timeSeries).sort((a, b) => new Date(b) - new Date(a)).slice(0, timeframeDays);
          data = dates.map(date => ({
            timestamp: date,
            open: parseFloat(timeSeries[date]['1. open']),
            high: parseFloat(timeSeries[date]['2. high']),
            low: parseFloat(timeSeries[date]['3. low']),
            price: parseFloat(timeSeries[date]['4. close']),
            volume: parseFloat(timeSeries[date]['5. volume'])
          }));
        } else {
          // Use Binance for crypto, forex, commodities
          const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${assetValue}&interval=1d&limit=${timeframeDays}`);
          const json = await response.json();
          if (!Array.isArray(json)) throw new Error('No data returned');
          data = json.map(candle => ({
            timestamp: new Date(candle[0]).toISOString().split('T')[0],
            open: parseFloat(candle[1]),
            high: parseFloat(candle[2]),
            low: parseFloat(candle[3]),
            price: parseFloat(candle[4]),
            volume: parseFloat(candle[5])
          }));
        }

        // Debug data
        debugDiv.textContent = `Data Length: ${data.length}\nSample: ${JSON.stringify(data.slice(0, 5), null, 2)}`;

        // Run strategies
        const results = strategies.map(strategy => strategy.evaluate(data));

        // Update chart
        if (chart) chart.destroy();
        const chartCtx = document.getElementById('chart').getContext('2d');
        chart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels: data.map(d => d.timestamp),
            datasets: [{
              label: `${assetValue} Price`,
              data: data.map(d => d.price),
              borderColor: 'blue',
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: 'Date' } },
              y: { title: { display: true, text: 'Price' } }
            }
          }
        });

        // Display results
        resultsDiv.innerHTML = '';
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>Strategy</th><th>Signal</th><th>Description</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        results.forEach(result => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${result.description}</td><td>${result.signal}</td><td>${result.description}</td>`; // Note: description twice? Adjust if needed
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        resultsDiv.appendChild(table);
      } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = 'Error fetching data: ' + error.message + '. Check console for details.';
      }
    });
  </script>
</body>
</html>
